{
    "http": {
        "routers": [
            {
                "name": "portal-grafana-proxy",
                "middlewares": [
                    "portalGrafanaCSP",
                    "portalGrafanaRedirectRegex",
                    "portalGrafanaOauth2",
                    "portalGrafanaAuthBearer",
                    "portalGrafanaBearerOnly",
                    "portalGrafanaHeaders"
                ],
                "rule": "PathPrefix('/ips/portal-monitoring')",
                "service": "portal-grafana-proxy"
            },
            {
                "name": "prometheus-proxy",
                "middlewares": [
                    "prometheusRedirect",
                    "portalGrafanaOauth2",
                    "portalGrafanaAuthBearer",
                    "portalGrafanaBearerOnly",
                    "portalGrafanaHeaders",
                    "prometheusRewritePath"
                ],
                "rule": "PathPrefix('/ips/prometheus')",
                "service": "prometheus-proxy"
            },
            {
                "name": "alertmanager-proxy",
                "middlewares": [
                    "alertmanagerRedirect",
                    "portalGrafanaOauth2",
                    "portalGrafanaAuthBearer",
                    "portalGrafanaBearerOnly",
                    "portalGrafanaHeaders",
                    "alertmanagerRewritePath"
                ],
                "rule": "PathPrefix('/ips/alertmanager')",
                "service": "alertmanager-proxy"
            },
            {
                "name": "jaeger-proxy",
                "middlewares": [
                    "portalGrafanaOauth2",
                    "portalGrafanaAuthBearer",
                    "portalGrafanaBearerOnly",
                    "portalGrafanaHeaders"
                ],
                "rule": "PathPrefix('/ips/jaeger')",
                "service": "jaeger-proxy"
            }
        ],
        "middlewares": [
            {
                "name": "prometheusRedirect",
                "type": "redirectRegex",
                "options": {
                    "regex": "^(/ips/prometheus)$",
                    "replacement": "$1/"
                }
            },
            {
                "name": "prometheusRewritePath",
                "type": "replacePathRegex",
                "options": {
                    "regex": "^/ips/prometheus/(.*)$",
                    "replacement": "/$1"
                }
            },
            {
                "name": "alertmanagerRedirect",
                "type": "redirectRegex",
                "options": {
                    "regex": "^(/ips/alertmanager)$",
                    "replacement": "$1/"
                }
            },
            {
                "name": "alertmanagerRewritePath",
                "type": "replacePathRegex",
                "options": {
                    "regex": "^/ips/alertmanager/(.*)$",
                    "replacement": "/$1"
                }
            },
            {
                "name": "jaegerRedirect",
                "type": "redirectRegex",
                "options": {
                    "regex": "^(/ips/jaeger)$",
                    "replacement": "$1/"
                }
            },
            {
                "name": "jaegerRewritePath",
                "type": "replacePathRegex",
                "options": {
                    "regex": "^/ips/jaeger/(.*)$",
                    "replacement": "/$1"
                }
            },
            {
                "name": "portalGrafanaCSP",
                "type": "csp",
                "options": {
                    "policyDirectives": [
                        {
                            "directive": "connect-src",
                            "values": [
                                "https://grafana.com",
                                "data:"
                            ]
                        }
                    ]
                }
            },
            {
                "name": "portalGrafanaRedirectRegex",
                "type": "redirectRegex",
                "options": {
                    "regex": "^(/ips/portal-monitoring)$",
                    "replacement": "$1/"
                }
            },
            {
                "name": "portalGrafanaHeaders",
                "type": "headers",
                "options": {
                    "customRequestHeaders": {
                        "Authorization": ""
                    },
                    "customResponseHeaders": {
                        "Authorization": ""
                    }
                }
            },
            {
                "name": "portalGrafanaOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "${PORTAL_GATEWAY_CLIENT_ID}",
                    "clientSecret": "${PORTAL_GATEWAY_CLIENT_SECRET}",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Portal-Monitoring"
                }
            },
            {
                "name": "portalGrafanaAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Portal-Monitoring"
                }
            },
            {
                "name": "portalGrafanaBearerOnly",
                "type": "bearerOnly",
                "options": {
                    "publicKeys": [
                        {
                            "publicKey": "${PORTAL_GATEWAY_BEARER_TOKEN_PUBLIC_KEY}"
                        }
                    ],
                    "audience": [
                        "Portal-Monitoring"
                    ],
                    "issuer": "${PORTAL_GATEWAY_BEARER_TOKEN_ISSUER}",
                    "optional": "${PORTAL_GATEWAY_BEARER_TOKEN_OPTIONAL}",
                    "claims": [
                        {
                            "claimPath": "$['resource_access']['Portal-Monitoring']['roles']",
                            "operator": "CONTAINS",
                            "value": [
                                "ADMIN"
                            ]
                        }
                    ],
                    "publicKeysReconcilation": {
                        "enabled": true,
                        "intervalMs": 3600000
                    }
                }
            }
        ],
        "services": [
            {
                "name": "portal-grafana-proxy",
                "servers": [
                    {
                        "host": "${PORTAL_GATEWAY_PORTAL_GRAFANA_HOST}",
                        "port": "${PORTAL_GATEWAY_PORTAL_GRAFANA_PORT}"
                    }
                ]
            },
            {
                "name": "prometheus-proxy",
                "servers": [
                    {
                        "host": "${PROMETHEUS_HOST}",
                        "port": "${PROMETHEUS_PORT}"
                    }
                ]
            },
            {
                "name": "alertmanager-proxy",
                "servers": [
                    {
                        "host": "${ALERTMANAGER_HOST}",
                        "port": "${ALERTMANAGER_PORT}"
                    }
                ]
            },
            {
                "name": "jaeger-proxy",
                "servers": [
                    {
                        "host": "${JAEGER_HOST}",
                        "port": "${JAEGER_PORT}"
                    }
                ]
            }
        ]
    }
}
