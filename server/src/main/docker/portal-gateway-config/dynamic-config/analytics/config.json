{
  "http": {
    "routers": [
      {
        "name": "analytics-admin",
        "middlewares": [
          "analyticsAdminRedirectRegex",
          "analyticsOauth2",
          "analyticsAuthBearer",
          "analyticsBearerOnly",
          "analyticsReplacePath"
        ],
        "rule": "PathPrefix('/analytics-admin')",
        "service": "analytics-proxy"
      },
      {
        "name": "analytics-public-tracker",
        "middlewares": [
          "analyticsPublicReplacePath"
        ],
        "rule": "PathPrefix('/analytics/matomo.php')",
        "service": "analytics-proxy"
      },
      {
        "name": "analytics-public-tracker-script",
        "middlewares": [
          "analyticsPublicReplacePath"
        ],
        "rule": "PathPrefix('/analytics/matomo.js')",
        "service": "analytics-proxy"
      }
    ],
    "middlewares": [
      {
        "name": "analyticsAdminRedirectRegex",
        "type": "redirectRegex",
        "options": {
          "regex": "^(/analytics-admin)$",
          "replacement": "$1/"
        }
      },
      {
        "name": "analyticsOauth2",
        "type": "oauth2",
        "options": {
          "clientId": "Portal-Gateway",
          "clientSecret": "Portal-Gateway!",
          "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
          "sessionScope": "Portal-Analytics"
        }
      },
      {
        "name": "analyticsAuthBearer",
        "type": "authorizationBearer",
        "options": {
          "sessionScope": "Portal-Analytics"
        }
      },
      {
        "name": "analyticsBearerOnly",
        "type": "bearerOnly",
        "options": {
          "publicKeys": [
            {
              "publicKey": "${PORTAL_GATEWAY_BEARER_TOKEN_PUBLIC_KEY}",
              "publicKeyAlgorithm": "RS256"
            }
          ],
          "audience": ["Portal-Analytics"],
          "issuer": "${PORTAL_GATEWAY_BEARER_TOKEN_ISSUER}",
          "optional": "${PORTAL_GATEWAY_BEARER_TOKEN_OPTIONAL}",
          "claims": [
            {
              "claimPath": "$['resource_access']['Portal-Analytics']['roles']",
              "operator": "CONTAINS",
              "value": ["ADMIN"]
            }
          ]
        }
      },
      {
        "name": "analyticsReplacePath",
        "type": "replacePathRegex",
        "options": {
          "regex": "/analytics-admin/(.*)",
          "replacement": "/$1"
        }
      },
      {
        "name": "analyticsPublicReplacePath",
        "type": "replacePathRegex",
        "options": {
          "regex": "/analytics/(.*)",
          "replacement": "/$1"
        }
      }
    ],
    "services": [
      {
        "name": "analytics-proxy",
        "servers": [
          {
            "host": "${PORTAL_GATEWAY_ANALYTICS_HOST}",
            "port": "${PORTAL_GATEWAY_ANALYTICS_PORT}"
          }
        ]
      }
    ]
  }
}
