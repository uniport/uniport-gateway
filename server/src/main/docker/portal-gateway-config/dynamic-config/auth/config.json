{
    "http": {
        "routers": [
            {
                "name": "auth",
                "rule": "PathPrefix('/auth')",
                "middlewares": [
                    "authRedirectRegex",
                    "languageCookie"
                ],
                "service": "portal-iam"
            }
        ],
        "middlewares": [
            {
                "name": "authRedirectRegex",
                "type": "redirectRegex",
                "options": {
                    "regex": "^/(?!auth/realms/portal|auth/realms/idp1|auth/resources|auth/js).*",
                    "replacement": "/login"
                }
            },
            {
                "name": "baseAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "id"
                }
            },
            {
                "name": "conversationAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Conversation"
                }
            },
            {
                "name": "conversationOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Conversation"
                }
            },
            {
                "name": "dashboardAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "id"
                }
            },
            {
                "name": "dashboardOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Dashboard"
                }
            },
            {
                "name": "organisationAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Organisation"
                }
            },
            {
                "name": "organisationOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Organisation"
                }
            },
            {
                "name": "documentAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Document"
                }
            },
            {
                "name": "documentOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Document"
                }
            },
            {
                "name": "filestorageAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "id"
                }
            },
            {
                "name": "portalPgadminOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Portal-Database"
                }
            },
            {
                "name": "portalPgadminAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Portal-Database"
                }
            },
            {
                "name": "portalPgadminBearerOnly",
                "type": "bearerOnly",
                "options": {
                    "publicKey": "${PORTAL_GATEWAY_BEARER_TOKEN_PUBLIC_KEY}",
                    "publicKeyAlgorithm": "RS256",
                    "audience": [
                        "Portal-Database"
                    ],
                    "issuer": "${PORTAL_GATEWAY_BEARER_TOKEN_ISSUER}",
                    "optional": "${PORTAL_GATEWAY_BEARER_TOKEN_OPTIONAL}",
                    "claims": [
                        {
                            "claimPath": "$['resource_access']['Portal-Database']['roles']",
                            "operator": "CONTAINS",
                            "value": [
                                "ADMIN"
                            ]
                        }
                    ]
                }
            },
            {
                "name": "portalGrafanaOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Portal-Monitoring"
                }
            },
            {
                "name": "portalGrafanaAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Portal-Monitoring"
                }
            },
            {
                "name": "portalGrafanaBearerOnly",
                "type": "bearerOnly",
                "options": {
                    "publicKey": "${PORTAL_GATEWAY_BEARER_TOKEN_PUBLIC_KEY}",
                    "publicKeyAlgorithm": "RS256",
                    "audience": [
                        "Portal-Monitoring"
                    ],
                    "issuer": "${PORTAL_GATEWAY_BEARER_TOKEN_ISSUER}",
                    "optional": "${PORTAL_GATEWAY_BEARER_TOKEN_OPTIONAL}",
                    "claims": [
                        {
                            "claimPath": "$['resource_access']['Portal-Monitoring']['roles']",
                            "operator": "CONTAINS",
                            "value": [
                                "ADMIN"
                            ]
                        }
                    ]
                }
            },
            {
                "name": "ShowSessionContentMiddleware",
                "type": "_session_",
                "options": {}
            },
            {
                "name": "whitelistedCookiesInSessionBag",
                "type": "sessionBag",
                "options": {
                    "whitelistedCookies": [
                        {
                            "name": "KEYCLOAK_SESSION",
                            "path": "/auth/realms/master/"
                        },
                        {
                            "name": "KEYCLOAK_SESSION_LEGACY",
                            "path": "/auth/realms/master/"
                        },
                        {
                            "name": "KEYCLOAK_SESSION",
                            "path": "/auth/realms/portal/"
                        },
                        {
                            "name": "KEYCLOAK_SESSION_LEGACY",
                            "path": "/auth/realms/portal/"
                        },
                        {
                            "name": "ips.language",
                            "path": "/"
                        }
                    ]
                }
            },
            {
                "name": "languageCookie",
                "type": "languageCookie",
                "options": {}
            },
            {
                "name": "portalKowlOauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Portal-Messaging"
                }
            },
            {
                "name": "portalKowlAuthBearer",
                "type": "authorizationBearer",
                "options": {
                    "sessionScope": "Portal-Messaging"
                }
            },
            {
                "name": "portalKowlBearerOnly",
                "type": "bearerOnly",
                "options": {
                    "publicKey": "${PORTAL_GATEWAY_BEARER_TOKEN_PUBLIC_KEY}",
                    "publicKeyAlgorithm": "RS256",
                    "audience": [
                        "Portal-Messaging"
                    ],
                    "issuer": "${PORTAL_GATEWAY_BEARER_TOKEN_ISSUER}",
                    "optional": "${PORTAL_GATEWAY_BEARER_TOKEN_OPTIONAL}",
                    "claims": [
                        {
                            "claimPath": "$['resource_access']['Portal-Messaging']['roles']",
                            "operator": "CONTAINS",
                            "value": [
                                "ADMIN"
                            ]
                        }
                    ]
                }
            }
        ],
        "services": [
            {
                "name": "portal-iam",
                "servers": [
                    {
                        "host": "${PORTAL_GATEWAY_PORTAL_IAM_HOST}",
                        "port": "${PORTAL_GATEWAY_PORTAL_IAM_PORT}"
                    }
                ]
            }
        ]
    }
}
