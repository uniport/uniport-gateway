{
    "http": {
        "routers": [
            {
                "name": "root",
                "middlewares": ["rootRedirectregex"],
                "rule": "Path('/')",
                "service": "whoami1-service"
            },

            {
                "name": "auth",
                "rule": "PathPrefix('/auth')",
                "service": "portal-iam"
            },

            {
                "name": "whoami1",
                "middlewares": [
                    "whoami1RedirectRegex",
                    "ShowSessionContentMiddleware",
                    "whoami1Oauth2",
                    "whoami1AuthBearer",
                    "whoami1ReplacePath"
                ],
                "rule": "PathPrefix('/whoami1')",
                "service": "whoami1-service"
            },

            {
                "name": "whoami2",
                "middlewares": [
                    "whoami2RedirectRegex",
                    "whoami2Oauth2",
                    "whoami2AuthBearer",
                    "whoami2ReplacePath"
                ],
                "rule": "PathPrefix('/whoami2')",
                "service": "whoami2-service"
            }
        ],

        "middlewares": [
            {
                "name": "whoami1AuthBearer",
                "type": "authorizationBearer",
                "options": { "sessionScope": "Organisation" }
            },
            {
                "name": "whoami1Oauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Organisation"
                }
            },

            {
                "name": "whoami2AuthBearer",
                "type": "authorizationBearer",
                "options": { "sessionScope": "Dashboard" }
            },
            {
                "name": "whoami2Oauth2",
                "type": "oauth2",
                "options": {
                    "clientId": "Portal-Gateway",
                    "clientSecret": "Portal-Gateway!",
                    "discoveryUrl": "http://${PORTAL_GATEWAY_PORTAL_IAM_HOST}:${PORTAL_GATEWAY_PORTAL_IAM_PORT}/auth/realms/portal",
                    "sessionScope": "Dashboard"
                }
            },

            {
                "name": "rootRedirectregex",
                "type": "redirectRegex",
                "options": { "regex": "^/$", "replacement": "/whoami1/" }
            },

            {
                "name": "whoami1LoginRedirectRegex",
                "type": "redirectRegex",
                "options": {
                    "regex": "^(/whoami1/login)$",
                    "replacement": "/whoami1/"
                }
            },
            {
                "name": "whoami1RedirectRegex",
                "type": "redirectRegex",
                "options": { "regex": "^(/whoami1)$", "replacement": "$1/" }
            },
            {
                "name": "whoami1ReplacePath",
                "type": "replacePathRegex",
                "options": { "regex": "/whoami1/(.*)", "replacement": "/$1" }
            },

            {
                "name": "whoami2RedirectRegex",
                "type": "redirectRegex",
                "options": { "regex": "^(/whoami2)$", "replacement": "$1/" }
            },
            {
                "name": "whoami2ReplacePath",
                "type": "replacePathRegex",
                "options": { "regex": "/whoami2/(.*)", "replacement": "/$1" }
            },

            {
                "name": "ShowSessionContentMiddleware",
                "type": "_session_",
                "options": {}
            }
        ],

        "services": [
            {
                "name": "portal-iam",
                "servers": [
                    {
                        "host": "${PORTAL_GATEWAY_PORTAL_IAM_HOST}",
                        "port": 8080
                    }
                ]
            },

            {
                "name": "whoami1-service",
                "servers": [{ "host": "${whoami1.host}", "port": 8001 }]
            },

            {
                "name": "whoami2-service",
                "servers": [{ "host": "${whoami2.host}", "port": 8002 }]
            }
        ]
    }
}
